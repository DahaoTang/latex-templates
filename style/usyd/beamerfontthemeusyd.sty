\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerfontthemeusyd}[University of Sydney Beamer Font Theme]

%==============================================================================
%                               MODE: PRESENTATION
%==============================================================================
\mode<presentation>

%==============================================================================
%                                ENGINE CHECK
%==============================================================================
% This theme relies on 'fontspec' which requires XeLaTeX or LuaLaTeX.
% We explicitly check for XeLaTeX as per the original design.
\RequirePackage{iftex}
\ifXeTeX\else
  \PackageError{beamerfontthemeusyd}{This theme requires XeLaTeX}{Please compile using xelatex.}
\fi

%==============================================================================
%                                 DEPENDENCIES
%==============================================================================
\RequirePackage{fontspec}
\RequirePackage{amsmath}
\RequirePackage{amssymb}

%==============================================================================
%                             FONT CONFIGURATION
%==============================================================================

% --- Configuration ---
\defaultfontfeatures{Ligatures=TeX}
\newcommand*\USYDFontPath{../../style/usyd/fonts/}

% --- Main & Sans Fonts (Tw Cen MT) ---
% Note: Using "FakeBold" and "FakeSlant" because the source likely 
% only provides a single weight/style file.
\setmainfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

\setsansfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

% --- Monospace Font (Google Sans Code) ---
\setmonofont{GoogleSansCode-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  Scale          = MatchLowercase,
  UprightFont    = GoogleSansCode-Regular,
  ItalicFont     = GoogleSansCode-Italic,
  BoldFont       = GoogleSansCode-Bold,
  BoldItalicFont = GoogleSansCode-BoldItalic
]

%==============================================================================
%                               MATH FONTS
%==============================================================================
% Strategy:
% 1. Define a font family for 'Tinos' (used for math symbols).
% 2. Capture the internal NFSS family name of Tinos and Monospace.
% 3. Map standard math alphabets (\mathrm, \mathbf, etc.) to use these families.

% 1. Define Tinos Family
\newfontfamily\USYDTinos{Tinos-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tinos-Regular,
  ItalicFont     = Tinos-Italic,
  BoldFont       = Tinos-Bold,
  BoldItalicFont = Tinos-BoldItalic
]

% 2. Capture Family Names & 3. Map Alphabets
\newcommand*\USYD@TinosFamily{}
\newcommand*\USYD@MonoFamily{}

\AtBeginDocument{%
  % Capture internal family names
  \begingroup\USYDTinos\global\edef\USYD@TinosFamily{\f@family}\endgroup%
  \begingroup\ttfamily \global\edef\USYD@MonoFamily {\f@family}\endgroup%

  % Map standard math alphabets to Tinos (Serif Math)
  \DeclareMathAlphabet{\mathnormal}{TU}{\USYD@TinosFamily}{m}{it}%
  \SetMathAlphabet{\mathnormal}{bold}{TU}{\USYD@TinosFamily}{b}{it}%
  
  \DeclareMathAlphabet{\mathrm}{TU}{\USYD@TinosFamily}{m}{n}%
  \SetMathAlphabet{\mathrm}{bold}{TU}{\USYD@TinosFamily}{b}{n}%
  
  \DeclareMathAlphabet{\mathbf}{TU}{\USYD@TinosFamily}{b}{n}%
  
  \DeclareMathAlphabet{\mathit}{TU}{\USYD@TinosFamily}{m}{it}%
  \SetMathAlphabet{\mathit}{bold}{TU}{\USYD@TinosFamily}{b}{it}%
  
  \DeclareMathAlphabet{\mathsf}{TU}{\USYD@TinosFamily}{m}{n}%
  \SetMathAlphabet{\mathsf}{bold}{TU}{\USYD@TinosFamily}{b}{n}%
  
  % Map Monospace Math
  \DeclareMathAlphabet{\mathtt}{TU}{\USYD@MonoFamily}{m}{n}%
  \SetMathAlphabet{\mathtt}{bold}{TU}{\USYD@MonoFamily}{b}{n}%
}

% --- Text Helper in Math Mode ---
% Ensures \text{...} inside an equation uses the Tinos font
\let\USYD@origtext\text
\renewcommand{\text}[1]{%
  \ifmmode\hbox{\USYDTinos #1}\else\USYD@origtext{#1}\fi%
}

%==============================================================================
%                           BEAMER FONT ASSIGNMENTS
%==============================================================================
% Titles
\setbeamerfont{title}      {family=\rmfamily, series=\bfseries, size=\LARGE}
\setbeamerfont{subtitle}   {family=\rmfamily, series=\bfseries, size=\Large}
\setbeamerfont{frametitle} {family=\rmfamily, series=\bfseries, size=\Large}

% Body
\setbeamerfont{normal text}{family=\rmfamily}
\setbeamerfont{structure}  {family=\rmfamily}

% Metadata & Blocks
\setbeamerfont{author}     {size=\normalsize}
\setbeamerfont{institute}  {size=\small}
\setbeamerfont{date}       {size=\small}
\setbeamerfont{block title}{size=\normalsize}
\setbeamerfont{block body} {size=\small}
\setbeamerfont{footline}   {size=\scriptsize}

% Footline
\setbeamerfont{institute in footline}  {size=\small}

%==============================================================================
%                               MODE: ALL
%==============================================================================
\mode<all>