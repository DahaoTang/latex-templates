\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeusyd}[University of Sydney Beamer Theme]

%==============================================================================
%                                ENGINE CHECK
%==============================================================================
% This theme relies on 'fontspec' features (FakeBold/Slant) which require XeLaTeX.
\RequirePackage{iftex}
\ifXeTeX\else
  \PackageError{beamerthemeusyd}{This theme requires XeLaTeX}{Please compile using xelatex.}
\fi

%==============================================================================
%                                DEPENDENCIES
%==============================================================================
% --- Core Utilities ---
\RequirePackage{etoolbox}             % Conditional logic
\RequirePackage{calc}                 % Length calculations

% --- Graphics & Layout ---
\RequirePackage{tikz}                 % Drawing the background layout
\RequirePackage{bookmark}  			      % Fixes PDF bookmarks in Beamer
\RequirePackage[export]{adjustbox}    % "Object-fit: cover" for title images

% --- Images ---
\RequirePackage{graphicx}             % Image handling

% --- Fonts & Math ---
\RequirePackage{fontspec}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsfonts}

% --- Tables ---
\RequirePackage{booktabs}             % Professional tables

% --- Extras ---
\RequirePackage{listings}             % Code formatting

% --- Bibliography (BibLaTeX) ---
\RequirePackage[
  backend=biber,                      % The modern backend engine (supports UTF-8 better)
  style=ieee,                         % IEEE style is standard for medical/engineering
  sorting=none,                       % Citations appear in order of appearance
  maxcitenames=1,                     % Force "et al." for citations in text (e.g. [1])
  mincitenames=1
]{biblatex}
\renewcommand*{\bibfont}{\tiny}

%==============================================================================
%                               MODE: PRESENTATION
%==============================================================================
\mode<presentation>

%==============================================================================
%                                CONFIGURATION
%==============================================================================

% --- Asset Paths ---
\newcommand*\USYDFontPath{fonts/}
\graphicspath{{assets/}}

% --- Internal Variables ---
\gdef\USYD@logo{USYDLogo}
\gdef\USYD@titlegraphic{USYDCover}

%==============================================================================
%                                1. COLOURS
%==============================================================================

% --- Palette ---
\definecolor{usydred}   {RGB}{236,  95,  50}
\definecolor{usydblack} {RGB}{ 20,  20,  20}
\definecolor{usydwhite} {RGB}{255, 255, 255}
\definecolor{usydgrey}  {RGB}{241, 241, 241}

% --- Global Text ---
\setbeamercolor{normal text}  {fg=usydblack, bg=usydwhite}
\setbeamercolor{structure}    {fg=usydred}

% --- Title Page & Metadata ---
\setbeamercolor{title}        {fg=usydwhite, bg=usydred}
\setbeamercolor{subtitle}     {fg=usydblack}

% --- Footline ---
\setbeamercolor{footline}     {fg=usydblack, bg=usydwhite}

%==============================================================================
%                                2. FONTS
%==============================================================================
\defaultfontfeatures{Ligatures=TeX}

% --- Main & Sans Fonts (Tw Cen MT) ---
\setmainfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

\setsansfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

% --- Monospace Font (Google Sans Code) ---
\setmonofont{GoogleSansCode-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  Scale          = MatchLowercase,
  UprightFont    = GoogleSansCode-Regular,
  ItalicFont     = GoogleSansCode-Italic,
  BoldFont       = GoogleSansCode-Bold,
  BoldItalicFont = GoogleSansCode-BoldItalic
]

% --- Math Fonts (Custom Tinos Integration) ---
% 1. Define Tinos Family
\newfontfamily\USYDTinos{Tinos-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tinos-Regular,
  ItalicFont     = Tinos-Italic,
  BoldFont       = Tinos-Bold,
  BoldItalicFont = Tinos-BoldItalic
]

% 2. Capture Family Names & Map Alphabets (Post-Preamble)
\newcommand*\USYD@TinosFamily{}
\newcommand*\USYD@MonoFamily{}

\AtBeginDocument{
  % Capture internal family names
  \begingroup\USYDTinos\global\edef\USYD@TinosFamily{\f@family}\endgroup
  \begingroup\ttfamily \global\edef\USYD@MonoFamily {\f@family}\endgroup

  % Map standard math alphabets to Tinos (Serif Math)
  \DeclareMathAlphabet{\mathnormal}{TU}{\USYD@TinosFamily}{m}{it}
  \SetMathAlphabet{\mathnormal}{bold}{TU}{\USYD@TinosFamily}{b}{it}
  \DeclareMathAlphabet{\mathrm}{TU}{\USYD@TinosFamily}{m}{n}
  \SetMathAlphabet{\mathrm}{bold}{TU}{\USYD@TinosFamily}{b}{n}
  \DeclareMathAlphabet{\mathbf}{TU}{\USYD@TinosFamily}{b}{n}
  \DeclareMathAlphabet{\mathit}{TU}{\USYD@TinosFamily}{m}{it}
  \SetMathAlphabet{\mathit}{bold}{TU}{\USYD@TinosFamily}{b}{it}
  \DeclareMathAlphabet{\mathsf}{TU}{\USYD@TinosFamily}{m}{n}
  \SetMathAlphabet{\mathsf}{bold}{TU}{\USYD@TinosFamily}{b}{n}
  
  % Map Monospace Math
  \DeclareMathAlphabet{\mathtt}{TU}{\USYD@MonoFamily}{m}{n}
  \SetMathAlphabet{\mathtt}{bold}{TU}{\USYD@MonoFamily}{b}{n}
}

% Ensure \text{...} inside equations uses Tinos
\let\USYD@origtext\text
\renewcommand{\text}[1]{
  \ifmmode\hbox{\USYDTinos #1}\else\USYD@origtext{#1}\fi
}

% --- Beamer Font Assignments ---
% Default
\setbeamerfont{normal text}     {family=\rmfamily}

% Title page
\setbeamerfont{title}           {family=\rmfamily, series=\bfseries, size=\LARGE}
\setbeamerfont{subtitle}        {family=\rmfamily, series=\bfseries, size=\large}
\setbeamerfont{institute}       {size=\small}
\setbeamerfont{date}            {size=\small}

% Footline
\setbeamerfont{footline}        {size=\scriptsize}

% Normal Page
\setbeamerfont{frametitle} {family=\rmfamily, series=\bfseries, size=\Large}


%==============================================================================
%                                3. LAYOUT & TEMPLATES
%==============================================================================

% --- General Settings ---
\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{bibliography item}[text]

\hypersetup{
  colorlinks=true,
  urlcolor=usydred,
  linkcolor=usydred,
  citecolor=usydblack,
}

% --- Background Template (The Split Screen) ---
\setbeamertemplate{background}{
  \begin{tikzpicture}
    \ifnum\thepage=1\relax
      % --- Title Page Layout ---
      \useasboundingbox (0,0) rectangle(\the\paperwidth, \the\paperheight);

      % 1. Left Panel (Red Text Area)
      \fill[color=usydred] (0,0) rectangle (0.5\paperwidth, \paperheight);

      % 2. Right Panel (Image Area with Clipping)
      \begin{scope}
        \clip (0.5\paperwidth, 0) rectangle (\paperwidth, \paperheight);
        
        % Background color failsafe
        \fill[color=usydwhite] 
             (0.5\paperwidth,0) rectangle (\paperwidth, \paperheight);

        % The Image Node (Centered in right pane)
        \node[inner sep=0pt, anchor=center] at (0.75\paperwidth, 0.5\paperheight) {
          \includegraphics[
            width=0.5\paperwidth,
            height=\paperheight,
            keepaspectratio,
            min width=0.5\paperwidth,
            min height=\paperheight
          ]{\USYD@titlegraphic}
        };
      \end{scope}

      % 3. Logo (Layered on top)
      \node[inner sep=0pt, anchor=base west] at (0.7, 0.5) {
		    \includegraphics[width=3.6cm]{\USYD@logo}
      };

    \else
      % --- Standard Page Layout ---
      \fill[usydwhite, opacity=1] (0,0) rectangle (\the\paperwidth, \the\paperheight);
    \fi
  \end{tikzpicture}
}

% --- Title Page Template ---
\defbeamertemplate*{title page}{usyd}[1][]{
  \newlength\beamertitlebox
  \setlength\beamertitlebox{\dimexpr0.5\paperwidth-\Gm@lmargin\relax}
  
  \begingroup
    \hskip-10pt
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{title}
      \usebeamerfont{title}\inserttitle\par
      \ifx\insertsubtitle\@empty
      \else
        \vskip0.25em
        {\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}
      \fi
    \end{beamercolorbox}
    \vskip3em

    \hskip-10pt
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{author}
      \usebeamerfont{author}\insertauthor
    \end{beamercolorbox}
    \vskip0.25em

    \hskip-10pt
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{institute}
      \usebeamerfont{institute}\insertinstitute
    \end{beamercolorbox}
    \vskip1em

    \hskip-10pt
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{date}
      \usebeamerfont{date}\insertdate
    \end{beamercolorbox}
  \endgroup
}

% --- Footline Template ---
\defbeamertemplate*{footline}{usyd}{
  \ifnum\thepage=1\relax
    % Empty footer on title page (placeholder to prevent shifts)
    \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=4ex]{placeholder}
    \end{beamercolorbox}
  \else
    % Standard footer
    \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=4ex, leftskip=3.5em, rightskip=4em]{footline}
      University of Sydney\hfill\insertframenumber{}
    \end{beamercolorbox}
  \fi
}

% --- Frametitle Template ---
\defbeamertemplate*{frametitle}{usyd}[1][]{
  \vskip12pt
  \begin{beamercolorbox}[#1]{frametitle}
    \usebeamerfont{frametitle}\insertframetitle\par
  \end{beamercolorbox}
}

% --- Code Style ---
\lstset{
  language=Python,
  basicstyle=\ttfamily\small\color{usydblack},
  keywordstyle=\color{usydred}\bfseries,
  stringstyle=\color{usydblack},
  commentstyle=\color{gray}\itshape,
  % Box styling
  backgroundcolor=\color{usydgrey},
  frame=l,
  rulecolor=\color{usydred},
  framesep=5pt,
  framerule=2pt,
  xleftmargin=10pt,
  % Layout
  columns=fullflexible,
  breaklines=true,
  showstringspaces=false
}

%==============================================================================
%                               MODE: ALL
%==============================================================================
\mode<all>