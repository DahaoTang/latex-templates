\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeusyd}[University of Sydney Beamer Theme]

%==============================================================================
%                               MODE: PRESENTATION
%==============================================================================
\mode<presentation>

%==============================================================================
%                                 DEPENDENCIES
%==============================================================================
\RequirePackage{tikz}                 % Drawing the background layout
\RequirePackage{graphicx}             % Image handling
\RequirePackage{etoolbox}             % Conditional logic (\ifdefempty)
\RequirePackage[export]{adjustbox}    % Make title image "cover" the area without distortion
\RequirePackage{listings}             % Code formatting

%==============================================================================
%                           ASSETS AND CONFIGURATION
%==============================================================================

% --- Path Configuration ---
% Look in local assets first, then shared style assets
\graphicspath{{assets/}{../../style/usyd/assets/}}

% --- Internal Variables (Defaults) ---
\gdef\USYD@logo{USYDLogo}
\gdef\USYD@affiliationlogo{}
\gdef\USYD@titlegraphic{USYDTitle}
\gdef\USYD@titlegraphicbackground{usydwhite}

% --- Public API (User Commands) ---
% \def\logo#1{\gdef\USYD@logo{#1}}
% \def\affiliationlogo#1{\gdef\USYD@affiliationlogo{#1}}
% \def\titlegraphic#1{\gdef\USYD@titlegraphic{#1}}
% \def\titlegraphicbackground#1{\gdef\USYD@titlegraphicbackground{#1}}

%==============================================================================
%                             THEME IMPORT
%==============================================================================
\RequirePackage{../../style/usyd/beamerfontthemeusyd}
\RequirePackage{../../style/usyd/beamercolorthemeusyd}

%==============================================================================
%                             GENERAL SETTINGS
%==============================================================================

% --- Hyperref Setup ---
\hypersetup{
  colorlinks=true,
  urlcolor=usydred,
  linkcolor=,
}

% --- Navigation ---
\setbeamertemplate{navigation symbols}{}

%==============================================================================
%                           TEMPLATE: BACKGROUND
%==============================================================================
\setbeamertemplate{background}{%
  \begin{tikzpicture}
    \ifnum\thepage=1\relax%
      % --- Title Page Layout ---
      \useasboundingbox (0,0) rectangle(\the\paperwidth, \the\paperheight);

      % 1. Left Panel (Red Text Area)
      \fill[color=usydred] (0,0) rectangle (0.6\paperwidth, \paperheight);

      % 2. Right Panel (Image Area with Clipping)
      % We use a scope and \clip to ensure the "cover" image doesn't bleed 
      % into the left panel or off the page.
      \begin{scope}
        \clip (0.6\paperwidth, 0) rectangle (\paperwidth, \paperheight);
        
        % Background color (failsafe if image is transparent or missing)
        \fill[color=\USYD@titlegraphicbackground] 
             (0.6\paperwidth,0) rectangle (\paperwidth, \paperheight);

        % The Image Node
        % centered at the middle of the right pane
        \node[inner sep=0pt, anchor=center] at (0.8\paperwidth, 0.5\paperheight) {%
          \includegraphics[
            % Logic for "Object Fit: Cover":
            % 1. Set width and height to the target box size
            width=0.4\paperwidth,
            height=\paperheight,
            % 2. Maintain aspect ratio
            keepaspectratio,
            % 3. Force minimum dimensions to ensure it covers the whole box
            % (Requires adjustbox package)
            min width=0.4\paperwidth,
            min height=\paperheight
          ]{\USYD@titlegraphic}%
        };
      \end{scope}

      % 3. Logos (Layered on top)
      \node[inner sep=0pt, anchor=base west] at (0.7, 0.5) {%
        \usebeamertemplate*{logo titlepage}%
      };

      % Optional affiliation logo
      % \node[inner sep=0pt] at (6.4, 1.4) {%
      %   \usebeamertemplate*{affiliationlogo titlepage}%
      % };

    \else
      % --- Standard Page Layout ---
      \fill[usydwhite, opacity=1] (0,0) rectangle (\the\paperwidth, \the\paperheight);
    \fi
  \end{tikzpicture}%
}

%==============================================================================
%                           TEMPLATE: TITLE PAGE
%==============================================================================
\defbeamertemplate*{title page}{usyd}[1][]{
  \newlength\beamertitlebox
  \setlength\beamertitlebox{\dimexpr0.6\paperwidth-\Gm@lmargin\relax}
  
  \begingroup
    \hskip-10pt%
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{title}
      \usebeamerfont{title}\inserttitle\par%
      \ifx\insertsubtitle\@empty%
      \else%
        \vskip0.25em%
        {\usebeamerfont{subtitle}\usebeamercolor[fg]{subtitle}\insertsubtitle\par}%
      \fi%
    \end{beamercolorbox}%
    \vskip2em

    \hskip-10pt%
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{author}
      \usebeamerfont{author}\insertauthor%
    \end{beamercolorbox}%
    \vskip0.25em

    \hskip-10pt%
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{institute}
      \usebeamerfont{institute}\insertinstitute%
    \end{beamercolorbox}%
    \vskip1em

    \hskip-10pt%
    \begin{beamercolorbox}[sep=0pt, wd=\beamertitlebox, #1]{date}
      \usebeamerfont{date}\insertdate%
    \end{beamercolorbox}
  \endgroup
}

%==============================================================================
%                           TEMPLATE: FOOTLINE
%==============================================================================
\defbeamertemplate*{footline}{usyd}{%
  \ifnum\thepage=1\relax%
    \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=4ex]{placeholder}%
    \end{beamercolorbox}%
  \else
    \begin{beamercolorbox}[wd=\paperwidth, ht=3ex, dp=4ex, leftskip=3.55em, rightskip=4em]{institute in footline}%
      University of Sydney\hfill\insertframenumber{}%
    \end{beamercolorbox}%
  \fi
}

%==============================================================================
%                           TEMPLATE: ELEMENTS
%==============================================================================

\defbeamertemplate*{logo titlepage}{usyd}{%
  \includegraphics[width=3.6cm]{\USYD@logo}%
}

\defbeamertemplate*{affiliationlogo titlepage}{usyd}{%
  \ifdefempty{\USYD@affiliationlogo}{}{%
    \includegraphics[width=2.2cm]{\USYD@affiliationlogo}%
  }%
}

\defbeamertemplate*{logo}{usyd}{%
  \includegraphics[height=3em]{\USYD@logo}%
}

\defbeamertemplate*{sidebar right}{usyd}{}

\defbeamertemplate*{frametitle}{usyd}[1][]{
  \vskip12pt%
  \begin{beamercolorbox}[#1]{frametitle}
    \usebeamerfont{frametitle}\insertframetitle\par%
  \end{beamercolorbox}%
}

% Configure code blocks to match the USYD Red/Grey theme
\lstset{
  language=Python,
  basicstyle=\ttfamily\small\color{usydblack},
  keywordstyle=\color{usydred}\bfseries,
  stringstyle=\color{usydblack},
  commentstyle=\color{gray}\itshape,
  %
  % Box styling
  backgroundcolor=\color{usydgrey},
  frame=l,             % Left line only
  rulecolor=\color{usydred},
  framesep=5pt,
  framerule=2pt,
  xleftmargin=10pt,
  %
  % Layout
  columns=fullflexible,
  breaklines=true,
  showstringspaces=false
}

%==============================================================================
%                               MODE: ALL
%==============================================================================
\mode<all>