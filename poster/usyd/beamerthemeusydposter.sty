\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{beamerthemeusydposter}[University of Sydney Beamer Poster Theme]

%==============================================================================
%                                ENGINE CHECK
%==============================================================================
% This theme relies on 'fontspec' features (FakeBold/Slant) which require XeLaTeX.
\RequirePackage{iftex}
\ifXeTeX\else
  \PackageError{beamerthemeusydposter}{This theme requires XeLaTeX}{Please compile using xelatex.}
\fi

%==============================================================================
%                               MODE: PRESENTATION
%==============================================================================
\mode<presentation>

%==============================================================================
%                                 DEPENDENCIES
%==============================================================================
% --- Core Utilities ---
\RequirePackage{etoolbox}             % Conditional logic
\RequirePackage{calc}                 % Length calculations

% --- Graphics & Layout ---
\RequirePackage{graphicx}             % Image handling
\RequirePackage{tikz}                 % Drawing features
\usetikzlibrary{positioning, calc}
\RequirePackage[export]{adjustbox}    % Image fitting
\RequirePackage{tcolorbox}            % Advanced block styling
\tcbuselibrary{raster,skins}

% --- Fonts & Math ---
\RequirePackage{fontspec}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsfonts}

% --- Tables & Code ---
\RequirePackage{booktabs}             % Professional tables
\RequirePackage{listings}             % Code formatting

% --- Bibliography (BibLaTeX) ---
\RequirePackage[
  backend=biber,                      % The modern backend engine (supports UTF-8 better)
  style=ieee,                         % IEEE style is standard for medical/engineering
  sorting=none,                       % Citations appear in order of appearance
  maxcitenames=1,                     % Force "et al." for citations in text (e.g. [1])
  mincitenames=1
]{biblatex}
\renewcommand*{\bibfont}{\tiny}

%==============================================================================
%                           ASSETS AND CONFIGURATION
%==============================================================================

% --- Path Configuration ---
\newcommand*\USYDFontPath{fonts/}
\graphicspath{{assets/}}

% --- Internal Variables (Defaults) ---
\gdef\USYD@logo{USYDLogo}

% Initialize these variables to empty strings to prevent errors
\gdef\USYD@poster@logoleftcontent{}
\gdef\USYD@poster@logorightcontent{}

% --- Public API (User Commands) ---
\def\logoleft#1{\gdef\USYD@poster@logoleftcontent{#1}}
\def\logoright#1{\gdef\USYD@poster@logorightcontent{#1}}

%==============================================================================
%                                1. COLOURS
%==============================================================================

% --- Palette ---
\definecolor{usydred}   {RGB}{236,  95,  50}
\definecolor{usydblack} {RGB}{ 20,  20,  20}
\definecolor{usydwhite} {RGB}{255, 255, 255}
\definecolor{usydgrey}  {RGB}{241, 241, 241}

% --- Global Text ---
\setbeamercolor{normal text}  {fg=usydblack, bg=usydwhite}
\setbeamercolor{structure}    {fg=usydred}

% --- Headline & Titles ---
\setbeamercolor{headline}     {fg=usydwhite, bg=usydred}

\setbeamercolor{title}		    {fg=usydwhite, bg=usydred}
\setbeamercolor{author}		    {fg=usydblack}
\setbeamercolor{institute}	  {fg=usydblack}

% --- Footline ---
\setbeamercolor{footline}     {fg=usydwhite, bg=usydred}

% --- Block and Subblock ---
\setbeamercolor{subblock}     {fg=usydwhite, bg=usydgrey}

%==============================================================================
%                                2. FONTS
%==============================================================================
\defaultfontfeatures{Ligatures=TeX}

% --- Main & Sans Fonts (Tw Cen MT) ---
\setmainfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

\setsansfont{Tw-Cen-MT}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tw-Cen-MT,
  BoldFont       = Tw-Cen-MT,
  ItalicFont     = Tw-Cen-MT,
  BoldItalicFont = Tw-Cen-MT,
  BoldFeatures   = {FakeBold=2.0},
  ItalicFeatures = {FakeSlant=0.20},
  BoldItalicFeatures = {FakeBold=2.0, FakeSlant=0.20}
]

% --- Monospace Font (Google Sans Code) ---
\setmonofont{GoogleSansCode-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  Scale          = MatchLowercase,
  UprightFont    = GoogleSansCode-Regular,
  ItalicFont     = GoogleSansCode-Italic,
  BoldFont       = GoogleSansCode-Bold,
  BoldItalicFont = GoogleSansCode-BoldItalic
]

% --- Math Fonts (Custom Tinos Integration) ---
% 1. Define Tinos Family
\newfontfamily\USYDTinos{Tinos-Regular}[
  Path           = \USYDFontPath,
  Extension      = .ttf,
  UprightFont    = Tinos-Regular,
  ItalicFont     = Tinos-Italic,
  BoldFont       = Tinos-Bold,
  BoldItalicFont = Tinos-BoldItalic
]

% 2. Capture Family Names & Map Alphabets (Post-Preamble)
\newcommand*\USYD@TinosFamily{}
\newcommand*\USYD@MonoFamily{}

\AtBeginDocument{
  % Capture internal family names
  \begingroup\USYDTinos\global\edef\USYD@TinosFamily{\f@family}\endgroup
  \begingroup\ttfamily \global\edef\USYD@MonoFamily {\f@family}\endgroup

  % Map standard math alphabets to Tinos (Serif Math)
  \DeclareMathAlphabet{\mathnormal}{TU}{\USYD@TinosFamily}{m}{it}
  \SetMathAlphabet{\mathnormal}{bold}{TU}{\USYD@TinosFamily}{b}{it}
  \DeclareMathAlphabet{\mathrm}{TU}{\USYD@TinosFamily}{m}{n}
  \SetMathAlphabet{\mathrm}{bold}{TU}{\USYD@TinosFamily}{b}{n}
  \DeclareMathAlphabet{\mathbf}{TU}{\USYD@TinosFamily}{b}{n}
  \DeclareMathAlphabet{\mathit}{TU}{\USYD@TinosFamily}{m}{it}
  \SetMathAlphabet{\mathit}{bold}{TU}{\USYD@TinosFamily}{b}{it}
  \DeclareMathAlphabet{\mathsf}{TU}{\USYD@TinosFamily}{m}{n}
  \SetMathAlphabet{\mathsf}{bold}{TU}{\USYD@TinosFamily}{b}{n}
  
  % Map Monospace Math
  \DeclareMathAlphabet{\mathtt}{TU}{\USYD@MonoFamily}{m}{n}
  \SetMathAlphabet{\mathtt}{bold}{TU}{\USYD@MonoFamily}{b}{n}
}

% Ensure \text{...} inside equations uses Tinos
\let\USYD@origtext\text
\renewcommand{\text}[1]{
  \ifmmode\hbox{\USYDTinos #1}\else\USYD@origtext{#1}\fi
}

% --- Beamer Font Assignments ---
% Default
\setbeamerfont{normal text}     {family=\rmfamily, size=\normalsize}

% Title page
\setbeamerfont{headline}        {size=\small}
\setbeamerfont{title}           {family=\rmfamily, series=\bfseries, size=\LARGE}
\setbeamerfont{author}          {size=\small}
\setbeamerfont{institute}       {size=\small}
\setbeamerfont{date}            {size=\small}

% Footline
\setbeamerfont{footline}        {size=\small}

% Normal Page
\setbeamerfont{frametitle} {family=\rmfamily, series=\bfseries, size=\Large}

%==============================================================================
%                            LAYOUT & TEMPLATES
%==============================================================================

% --- Navigation & Bibliography ---
\setbeamertemplate{navigation symbols}{}
\setbeamertemplate{bibliography item}{\insertbiblabel}

\hypersetup{
  colorlinks=true,
  urlcolor=usydred,
  linkcolor=usydred,
  citecolor=usydblack,
}

% --- Spacing Defaults ---
\setlength{\parskip}{0.35em}
\setlength{\parindent}{0pt}

% --- Code Styling ---
\lstset{
  language=Python,
  basicstyle=\ttfamily\small\color{usydblack},
  keywordstyle=\color{usydred}\bfseries,
  stringstyle=\color{usydblack},
  commentstyle=\color{gray}\itshape,
  backgroundcolor=\color{usydgrey},
  frame=l,
  rulecolor=\color{usydred},
  framesep=5pt,
  framerule=2pt,
  xleftmargin=10pt,
  columns=fullflexible,
  breaklines=true,
  showstringspaces=false
}

% --- Block Style ---
\defbeamertemplate*{block begin}{bordered}{%
  \tcbset{
    enhanced,
    sharp corners,
    colframe=usydred,
    colback=usydwhite,
    boxsep=0.6em,
    boxrule=0.1em,
    % left=0.8em,
    % right=0.8em,
    % top=0.7em,
    % bottom=0.7em,
    fonttitle=\bfseries,
  }
  \begin{tcolorbox}[title=\insertblocktitle]
}

\defbeamertemplate*{block end}{borderd}{%
  \end{tcolorbox}
  \vspace{1em}
}

% --- Headline ---
\setbeamertemplate{headline}{
  \vbox{
    \begin{beamercolorbox}[wd=\paperwidth, sep=1cm]{headline}
      \begin{columns}[c]
        
        % 1. Left Slot
        \begin{column}{0.25\paperwidth}
          \centering
          \USYD@poster@logoleftcontent
        \end{column}

        % 2. Center Slot
        \begin{column}{0.5\paperwidth}
          \centering
          \usebeamercolor{title}
          {\bfseries \Huge \inserttitle\par}
          \vspace{1em}
          {\Large \insertauthor\par}
          {\large \insertinstitute\par}
        \end{column}

        % 3. Right Slot
        \begin{column}{0.25\paperwidth}
          \centering
          \USYD@poster@logorightcontent
        \end{column}

      \end{columns}
    \end{beamercolorbox}
    \nointerlineskip
    \begin{beamercolorbox}[wd=\paperwidth, ht=0cm]{lower separation line head}
    \end{beamercolorbox}
  }
}

% --- Footline ---
\setbeamertemplate{footline}{
  \begin{beamercolorbox}[ht=1.8em,leftskip=1em,rightskip=1em]{footline}
    \centering
    \hfill
    \small\texttt{dahao.tang@sydney.edu.au}\hspace{2em}
    \vskip0.4em
  \end{beamercolorbox}%
}

\mode<all>